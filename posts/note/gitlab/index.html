<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>GitLab CI 入门 | Javen&#39;s Blog</title>
<meta name="keywords" content="CICD">
<meta name="description" content="GitLab入门">
<meta name="author" content="Javen">
<link rel="canonical" href="https://jary-287.github.io/cloudnative.github.io/posts/note/gitlab/">
<link crossorigin="anonymous" href="/cloudnative.github.io/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/cloudnative.github.io/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://jary-287.github.io/cloudnative.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://jary-287.github.io/cloudnative.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://jary-287.github.io/cloudnative.github.io/img/Q.gif">
<link rel="apple-touch-icon" href="https://jary-287.github.io/cloudnative.github.io/Q.gif">
<link rel="mask-icon" href="https://jary-287.github.io/cloudnative.github.io/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="GitLab CI 入门" />
<meta property="og:description" content="GitLab入门" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jary-287.github.io/cloudnative.github.io/posts/note/gitlab/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-01T15:53:53+08:00" />
<meta property="article:modified_time" content="2023-05-01T15:53:53+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GitLab CI 入门"/>
<meta name="twitter:description" content="GitLab入门"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "所有内容",
      "item": "https://jary-287.github.io/cloudnative.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "📕笔记",
      "item": "https://jary-287.github.io/cloudnative.github.io/posts/note/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "GitLab CI 入门",
      "item": "https://jary-287.github.io/cloudnative.github.io/posts/note/gitlab/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "GitLab CI 入门",
  "name": "GitLab CI 入门",
  "description": "GitLab入门",
  "keywords": [
    "CICD"
  ],
  "articleBody": " GitLab CI 入门 一、概述 1.组件 gitlab CI/CD gitlab的功能 gitlab Runner gitlab CICD的执行者 .gitlab-ci.yml 流水线描述文件，描述流水线执行的步骤 2.工作流程 将代码提交到git存储库\n在根目录中创建ci文件.gitlab-ci.yml,并在文件中指定各阶段操作\ngitlab监测到该文件并使用gitlab runner运行脚本\n脚本被分组成为作业，共同构成了一个管道\n3.jenkins VS gitlab CI jenkins 编译服务与代码库分离，耦合度低 插件丰富，支持语言多，但插件维护难 统一的web界面 体量大 权限管理难 gitlab CI 轻量级，不需要复杂的安装手段 配置简单 实时构建日志清晰 没有统一管理界面 配置依赖代码库，耦合度高 权限管理方便 二、gitlab 安装 1.gitlab 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # 使用清华源安装https://mirrors.tuna.tsinghua.edu.cn/help/gitlab-ce/，不然下载到死 # curl https://packages.gitlab.com/gpg.key 2\u003e /dev/null | sudo apt-key add - \u0026\u003e/dev/null # 添加镜像仓库 echo deb https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu focal main \u003e\u003e /etc/apt/sources.list.d/gitlab-ce.list # 更新并安装 ljw@server:~$ sudo apt-get update ljw@server:~$ sudo apt-get install gitlab-ce # 修改配置文件 ljw@server:~$ sudo cat /etc/gitlab/gitlab.rb | grep external_url | grep -v ^# external_url 'http://mygitlab.com' # 域名访问 # 重新配置并启动 ljw@server:~$ sudo gitlab-ctl reconfigure ljw@server:~$ sudo gitlab-ctl start # 查看默认密码然后登陆 ljw@server:~$ sudo cat /etc/gitlab/initial_root_password # WARNING: This value is valid only in the following conditions # 1. If provided manually (either via `GITLAB_ROOT_PASSWORD` environment variable or via `gitlab_rails['initial_root_password']` setting in `gitlab.rb`, it was provided before database was seeded for the first time (usually, the first reconfigure run). # 2. Password hasn't been changed manually, either via UI or via command line. # # If the password shown here doesn't work, you must reset the admin password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password. Password: Kkg82QhvKwvDbjTZ9ElwN7nuxe/MeNCkfG2V54weyaM= # NOTE: This file will be automatically deleted in the first reconfigure run after 24 hours. 三、runner 1.什么是runner runner是go语言编写的跨平台的gitlab执行作业的agent，用于持续集成和持续部署中的脚本任务 2.特点 同时运行多个作业 在本地/docker/k8s执行 连接到远程ssh服务器 自动加载 允许自定义作业环境 3.类型/状态 类型 sheard共享类型，全部可用 group项目组类型 specific特定项目类型，当前项目可用 状态 locked：锁定状态，无法运行作业 paused ：暂停状态，不会接受新的作业 4.安装 ubuntu安装 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 # gitlab runner管理界面展示了安装方法，照做即可 # Download the binary for your system sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64 # Give it permission to execute sudo chmod +x /usr/local/bin/gitlab-runner # Create a GitLab Runner user sudo useradd --comment 'GitLab Runner' --create-home gitlab-runner --shell /bin/bash # Install and run as a service sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner sudo gitlab-runner start # 注册 sudo gitlab-runner register --url http://mygitlab.com/ --registration-token M1jkqBfpuuzAnH9s7aYE # 删除 ljw@server:/etc$ sudo gitlab-runner verify --delete -t 7cEPwExkwMdD5_bU7ECh -u http://mygitlab.com/ # 注册相同,注册一个shared类型的runner ERRO[0000] Docker executor: prebuilt image helpers will be loaded from /var/lib/gitlab-runner. Running in system-mode. Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/): [http://mygitlab.com/]: Please enter the gitlab-ci token for this runner: [M1jkqBfpuuzAnH9s7aYE]: Please enter the gitlab-ci description for this runner: [server]: Please enter the gitlab-ci tags for this runner (comma separated): implement Registering runner... succeeded runner=M1jkqBfp Please enter the executor: ssh, virtualbox, docker+machine, docker-ssh+machine, docker-ssh, parallels, kubernetes, docker, shell: shell Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded! docker安装 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 # 创建配置文件挂在目录 ljw@server:~$ mkdir gitlab_runner_config # 启动容器 ljw@server:~$ sudo docker run -d --name gitlab-runner --restart always -v /var/run/docker.so^C:/var/run/docker.sock -v /home/ljw/gitlab_runner_config/:/etc/gitlab-runner gitlab/gitlab-runner:latest [sudo] password for ljw: Unable to find image 'gitlab/gitlab-runner:latest' locally latest: Pulling from gitlab/gitlab-runner 846c0b181fff: Pull complete f05423af2dfd: Pull complete d92eb7aeb475: Pull complete Digest: sha256:15a3945030802e20d24326aef1e60b69478336842db88069303ddfdfe9cebf9a Status: Downloaded newer image for gitlab/gitlab-runner:latest 6125256c41ce4dc86f54aac997b50a633b94a0c94209740a3dc3be9e4e0983b7 ljw@server:~$ sudo docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 6125256c41ce gitlab/gitlab-runner:latest \"/usr/bin/dumb-init …\" 19 seconds ago Up 17 seconds gitlab-runner # 新建一个测试项目，test # 略 # 注册一个特定项目runner，为test,确保容器能解析到mygitlab.com ljw@server:~$ sudo docker exec -it gitlab-runner /bin/bash root@6125256c41ce:/# gitlab-runner register --url http://mygitlab.com/ --registration-token GR1348941sgKMG1cURqipSf8s7u7M Runtime platform arch=amd64 os=linux pid=56 revision=6d480948 version=15.7.1 Running in system-mode. Enter the GitLab instance URL (for example, https://gitlab.com/): [http://mygitlab.com/]: Enter the registration token: [GR1348941sgKMG1cURqipSf8s7u7M]: Enter a description for the runner: [6125256c41ce]: Enter tags for the runner (comma-separated): Enter optional maintenance note for the runner: WARNING: Support for registration tokens and runner parameters in the 'register' command has been deprecated in GitLab Runner 15.6 and will be replaced with support for authentication tokens. For more information, see https://gitlab.com/gitlab-org/gitlab/-/issues/380872 Registering runner... succeeded runner=GR1348941sgKMG1cU Enter an executor: kubernetes, custom, docker, parallels, shell, ssh, docker+machine, instance, docker-ssh, virtualbox, docker-ssh+machine: shell Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded! Configuration (with the authentication token) was saved in \"/etc/gitlab-runner/config.toml\" 四、CICD流水线 1.基本使用 创建项目test ​\t项目根目录下创建流水线文件.gitlab-ci.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 stages: # List of stages for jobs, and their order of execution - build - test - deploy build-job: # This job runs in the build stage, which runs first. stage: build script: - echo \"Compiling the code...\" - echo \"Compile complete.\" unit-test-job: # This job runs in the test stage. stage: test # It only starts when the job in the build stage completes successfully. script: - echo \"Running unit tests... This will take about 60 seconds.\" - sleep 5 - echo \"Code coverage is 90%\" lint-test-job: # This job also runs in the test stage. stage: test # It can run at the same time as unit-test-job (in parallel). script: - echo \"Linting code... This will take about 10 seconds.\" - sleep 10 - echo \"No lint issues found.\" deploy-job: # This job runs in the deploy stage. stage: deploy # It only runs when *both* jobs in the test stage complete successfully. environment: production script: - echo \"Deploying application...\" - echo \"Application successfully deployed.\" 每一次修改都会触发流水线\n可点击某一次流水线查看执行详情\npipeline文件中定义了三个阶段，build，test，deploy，可分别查看\n​\t2.流水线语法检测 使用CI lint 检查pipeline文件语法是否正确，然后再修改仓库文件 3.pipeline语法 关键字概览 关键词 作用 job pipeline文件中由多个作业组成，每个作业必须有一个script，名字必须唯一 script 指定具体的操作，现在是shell语句 before_script 作业运行之前要做的操作，如果是全局的，每个作业都会执行 after_script 作业运行之后要做的操作，如果是全局的，每个作业都会执行 stages 控制stage的顺序，一个stage可能执行多个作业 stage 指定当前是哪个stage，两个关键字：.pre为第一个运行，.post为最后运行 variables 定义变量 tags 指定runner allow_failure 允许失败，默认值为false when 控制作业执行条件 retry 重试次数 timeout 超时时间 parallel 并行作业实例数，2",
  "wordCount" : "8009",
  "inLanguage": "en",
  "datePublished": "2023-05-01T15:53:53+08:00",
  "dateModified": "2023-05-01T15:53:53+08:00",
  "author":[{
    "@type": "Person",
    "name": "Javen"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jary-287.github.io/cloudnative.github.io/posts/note/gitlab/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Javen's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jary-287.github.io/cloudnative.github.io/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jary-287.github.io/cloudnative.github.io" accesskey="h" title="Javen&#39;s Blog (Alt + H)">
                <img src="https://www.sulvblog.cn/Q.gif" alt="" aria-label="logo"
                    height="35">Javen&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jary-287.github.io/cloudnative.github.io/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://jary-287.github.io/cloudnative.github.io/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://jary-287.github.io/cloudnative.github.io/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://jary-287.github.io/cloudnative.github.io/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://jary-287.github.io/cloudnative.github.io/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://jary-287.github.io/cloudnative.github.io/about" title="🙋🏻‍♂️关于">
                    <span>🙋🏻‍♂️关于</span>
                </a>
            </li>
            <li>
                <a href="https://jary-287.github.io/cloudnative.github.io/links" title="🤝友链">
                    <span>🤝友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://jary-287.github.io/cloudnative.github.io">Home</a>&nbsp;»&nbsp;<a href="https://jary-287.github.io/cloudnative.github.io/posts/">所有内容</a>&nbsp;»&nbsp;<a href="https://jary-287.github.io/cloudnative.github.io/posts/note/">📕笔记</a></div>
    <h1 class="post-title">
      GitLab CI 入门
    </h1>
    <div class="post-description">
      GitLab入门
    </div>
    <div class="post-meta"><span title='2023-05-01 15:53:53 +0800 CST'>2023-05-01</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;Javen

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#gitlab-ci-%e5%85%a5%e9%97%a8" aria-label="GitLab CI 入门">GitLab CI 入门</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%80%e6%a6%82%e8%bf%b0" aria-label="一、概述">一、概述</a><ul>
                            
                    <li>
                        <a href="#1%e7%bb%84%e4%bb%b6" aria-label="1.组件">1.组件</a><ul>
                            
                    <li>
                        <a href="#gitlab-cicd" aria-label="gitlab CI/CD">gitlab CI/CD</a></li>
                    <li>
                        <a href="#gitlab-runner" aria-label="gitlab Runner">gitlab Runner</a></li>
                    <li>
                        <a href="#gitlab-ciyml" aria-label=".gitlab-ci.yml">.gitlab-ci.yml</a></li></ul>
                    </li>
                    <li>
                        <a href="#2%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" aria-label="2.工作流程">2.工作流程</a></li>
                    <li>
                        <a href="#3jenkins-vs-gitlab-ci" aria-label="3.jenkins VS gitlab CI">3.jenkins VS gitlab CI</a><ul>
                            
                    <li>
                        <a href="#jenkins" aria-label="jenkins">jenkins</a></li>
                    <li>
                        <a href="#gitlab-ci" aria-label="gitlab CI">gitlab CI</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%8cgitlab-%e5%ae%89%e8%a3%85" aria-label="二、gitlab 安装">二、gitlab 安装</a><ul>
                            
                    <li>
                        <a href="#1gitlab" aria-label="1.gitlab">1.gitlab</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%89runner" aria-label="三、runner">三、runner</a><ul>
                            
                    <li>
                        <a href="#1%e4%bb%80%e4%b9%88%e6%98%afrunner" aria-label="1.什么是runner">1.什么是runner</a></li>
                    <li>
                        <a href="#2%e7%89%b9%e7%82%b9" aria-label="2.特点">2.特点</a></li>
                    <li>
                        <a href="#3%e7%b1%bb%e5%9e%8b%e7%8a%b6%e6%80%81" aria-label="3.类型/状态">3.类型/状态</a><ul>
                            
                    <li>
                        <a href="#%e7%b1%bb%e5%9e%8b" aria-label="类型">类型</a></li>
                    <li>
                        <a href="#%e7%8a%b6%e6%80%81" aria-label="状态">状态</a></li></ul>
                    </li>
                    <li>
                        <a href="#4%e5%ae%89%e8%a3%85" aria-label="4.安装">4.安装</a><ul>
                            
                    <li>
                        <a href="#ubuntu%e5%ae%89%e8%a3%85" aria-label="ubuntu安装">ubuntu安装</a></li>
                    <li>
                        <a href="#docker%e5%ae%89%e8%a3%85" aria-label="docker安装">docker安装</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%9b%9bcicd%e6%b5%81%e6%b0%b4%e7%ba%bf" aria-label="四、CICD流水线">四、CICD流水线</a><ul>
                            
                    <li>
                        <a href="#1%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8" aria-label="1.基本使用">1.基本使用</a></li>
                    <li>
                        <a href="#2%e6%b5%81%e6%b0%b4%e7%ba%bf%e8%af%ad%e6%b3%95%e6%a3%80%e6%b5%8b" aria-label="2.流水线语法检测">2.流水线语法检测</a></li>
                    <li>
                        <a href="#3pipeline%e8%af%ad%e6%b3%95" aria-label="3.pipeline语法">3.pipeline语法</a><ul>
                            
                    <li>
                        <a href="#%e5%85%b3%e9%94%ae%e5%ad%97%e6%a6%82%e8%a7%88" aria-label="关键字概览">关键字概览</a></li>
                    <li>
                        <a href="#%e5%9f%ba%e6%9c%ac%e5%85%b3%e9%94%ae%e5%ad%97%e4%bd%bf%e7%94%a8" aria-label="基本关键字使用">基本关键字使用</a></li>
                    <li>
                        <a href="#tagsallow_failurewhenretrytimeoutparallel" aria-label="tags、allow_failure、when、retry、timeout、parallel">tags、allow_failure、when、retry、timeout、parallel</a></li>
                    <li>
                        <a href="#onlyexceptrulesworkflow" aria-label="only,except,rules,workflow">only,except,rules,workflow</a></li>
                    <li>
                        <a href="#cacheartifactsdependencies" aria-label="cache,artifacts,dependencies">cache,artifacts,dependencies</a></li>
                    <li>
                        <a href="#needs" aria-label="needs">needs</a></li>
                    <li>
                        <a href="#imageservices" aria-label="image/services">image/services</a></li>
                    <li>
                        <a href="#environment" aria-label="environment">environment</a></li>
                    <li>
                        <a href="#inherit" aria-label="inherit">inherit</a></li></ul>
                    </li>
                    <li>
                        <a href="#4%e6%a8%a1%e7%89%88%e5%ba%93%e8%a7%84%e5%88%92" aria-label="4.模版库规划">4.模版库规划</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%94%e5%b7%a5%e5%85%b7%e9%93%be%e7%bb%a7%e6%89%bf" aria-label="五、工具链继承">五、工具链继承</a><ul>
                            
                    <li>
                        <a href="#1maven%e9%9b%86%e6%88%90" aria-label="1.Maven集成">1.Maven集成</a></li>
                    <li>
                        <a href="#2npm%e9%9b%86%e6%88%90" aria-label="2.Npm集成">2.Npm集成</a></li>
                    <li>
                        <a href="#3%e9%9b%86%e6%88%90%e5%88%b6%e5%93%81%e5%ba%93" aria-label="3.集成制品库">3.集成制品库</a></li>
                    <li>
                        <a href="#4%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e9%9b%86%e6%88%90" aria-label="4.镜像仓库集成">4.镜像仓库集成</a></li>
                    <li>
                        <a href="#5jmeter%e8%87%aa%e5%8a%a8%e5%8c%96%e6%b5%8b%e8%af%95%e9%9b%86%e6%88%90" aria-label="5.jmeter自动化测试集成">5.jmeter自动化测试集成</a></li>
                    <li>
                        <a href="#6sonarqube%e4%bb%a3%e7%a0%81%e6%89%ab%e6%8f%8f%e9%9b%86%e6%88%90" aria-label="6.SonarQube代码扫描集成">6.SonarQube代码扫描集成</a>
                    </li>
                </ul>
                </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><hr>
<h1 id="gitlab-ci-入门">GitLab CI 入门<a hidden class="anchor" aria-hidden="true" href="#gitlab-ci-入门">#</a></h1>
<h2 id="一概述">一、概述<a hidden class="anchor" aria-hidden="true" href="#一概述">#</a></h2>
<h3 id="1组件">1.组件<a hidden class="anchor" aria-hidden="true" href="#1组件">#</a></h3>
<h4 id="gitlab-cicd">gitlab CI/CD<a hidden class="anchor" aria-hidden="true" href="#gitlab-cicd">#</a></h4>
<ul>
<li>gitlab的功能</li>
</ul>
<h4 id="gitlab-runner">gitlab Runner<a hidden class="anchor" aria-hidden="true" href="#gitlab-runner">#</a></h4>
<ul>
<li>gitlab CICD的执行者</li>
</ul>
<h4 id="gitlab-ciyml">.gitlab-ci.yml<a hidden class="anchor" aria-hidden="true" href="#gitlab-ciyml">#</a></h4>
<ul>
<li>流水线描述文件，描述流水线执行的步骤</li>
</ul>
<h3 id="2工作流程">2.工作流程<a hidden class="anchor" aria-hidden="true" href="#2工作流程">#</a></h3>
<ul>
<li>
<p>将代码提交到git存储库</p>
</li>
<li>
<p>在根目录中创建ci文件.gitlab-ci.yml,并在文件中指定各阶段操作</p>
</li>
<li>
<p>gitlab监测到该文件并使用gitlab runner运行脚本</p>
</li>
<li>
<p>脚本被分组成为作业，共同构成了一个管道</p>
</li>
</ul>
<h3 id="3jenkins-vs-gitlab-ci">3.jenkins VS gitlab CI<a hidden class="anchor" aria-hidden="true" href="#3jenkins-vs-gitlab-ci">#</a></h3>
<h4 id="jenkins">jenkins<a hidden class="anchor" aria-hidden="true" href="#jenkins">#</a></h4>
<ul>
<li>编译服务与代码库分离，耦合度低</li>
<li>插件丰富，支持语言多，但插件维护难</li>
<li>统一的web界面</li>
<li>体量大</li>
<li>权限管理难</li>
</ul>
<h4 id="gitlab-ci">gitlab CI<a hidden class="anchor" aria-hidden="true" href="#gitlab-ci">#</a></h4>
<ul>
<li>轻量级，不需要复杂的安装手段</li>
<li>配置简单</li>
<li>实时构建日志清晰</li>
<li>没有统一管理界面</li>
<li>配置依赖代码库，耦合度高</li>
<li>权限管理方便</li>
</ul>
<h2 id="二gitlab-安装">二、gitlab 安装<a hidden class="anchor" aria-hidden="true" href="#二gitlab-安装">#</a></h2>
<h3 id="1gitlab">1.gitlab<a hidden class="anchor" aria-hidden="true" href="#1gitlab">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 使用清华源安装https://mirrors.tuna.tsinghua.edu.cn/help/gitlab-ce/，不然下载到死</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># curl https://packages.gitlab.com/gpg.key 2&gt; /dev/null | sudo apt-key add - &amp;&gt;/dev/null</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 添加镜像仓库</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">echo</span> deb https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu focal main &gt;&gt; /etc/apt/sources.list.d/gitlab-ce.list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 更新并安装</span>
</span></span><span style="display:flex;"><span>ljw@server:~$ sudo apt-get update
</span></span><span style="display:flex;"><span>ljw@server:~$ sudo apt-get install gitlab-ce
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 修改配置文件</span>
</span></span><span style="display:flex;"><span>ljw@server:~$ sudo cat /etc/gitlab/gitlab.rb | grep external_url | grep -v ^#
</span></span><span style="display:flex;"><span>external_url <span style="color:#0ff;font-weight:bold">&#39;http://mygitlab.com&#39;</span>  <span style="color:#007f7f"># 域名访问</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 重新配置并启动</span>
</span></span><span style="display:flex;"><span>ljw@server:~$ sudo gitlab-ctl reconfigure
</span></span><span style="display:flex;"><span>ljw@server:~$ sudo gitlab-ctl start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看默认密码然后登陆</span>
</span></span><span style="display:flex;"><span>ljw@server:~$ sudo cat /etc/gitlab/initial_root_password
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># WARNING: This value is valid only in the following conditions</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          1. If provided manually (either via `GITLAB_ROOT_PASSWORD` environment variable or via `gitlab_rails[&#39;initial_root_password&#39;]` setting in `gitlab.rb`, it was provided before database was seeded for the first time (usually, the first reconfigure run).</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          2. Password hasn&#39;t been changed manually, either via UI or via command line.</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#          If the password shown here doesn&#39;t work, you must reset the admin password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Password: Kkg82QhvKwvDbjTZ9ElwN7nuxe/MeNCkfG2V54weyaM=
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># NOTE: This file will be automatically deleted in the first reconfigure run after 24 hours.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/images/gitlab/image-20230109184709518.png" alt="image-20230109184709518"  />
</p>
<h2 id="三runner">三、runner<a hidden class="anchor" aria-hidden="true" href="#三runner">#</a></h2>
<h3 id="1什么是runner">1.什么是runner<a hidden class="anchor" aria-hidden="true" href="#1什么是runner">#</a></h3>
<ul>
<li>runner是go语言编写的跨平台的gitlab执行作业的agent，用于持续集成和持续部署中的脚本任务</li>
</ul>
<h3 id="2特点">2.特点<a hidden class="anchor" aria-hidden="true" href="#2特点">#</a></h3>
<ul>
<li>同时运行多个作业</li>
<li>在本地/docker/k8s执行</li>
<li>连接到远程ssh服务器</li>
<li>自动加载</li>
<li>允许自定义作业环境</li>
</ul>
<h3 id="3类型状态">3.类型/状态<a hidden class="anchor" aria-hidden="true" href="#3类型状态">#</a></h3>
<h4 id="类型">类型<a hidden class="anchor" aria-hidden="true" href="#类型">#</a></h4>
<ul>
<li>sheard共享类型，全部可用</li>
<li>group项目组类型</li>
<li>specific特定项目类型，当前项目可用</li>
</ul>
<h4 id="状态">状态<a hidden class="anchor" aria-hidden="true" href="#状态">#</a></h4>
<ul>
<li>locked：锁定状态，无法运行作业</li>
<li>paused ：暂停状态，不会接受新的作业</li>
</ul>
<h3 id="4安装">4.安装<a hidden class="anchor" aria-hidden="true" href="#4安装">#</a></h3>
<h4 id="ubuntu安装">ubuntu安装<a hidden class="anchor" aria-hidden="true" href="#ubuntu安装">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># gitlab runner管理界面展示了安装方法，照做即可</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Download the binary for your system</span>
</span></span><span style="display:flex;"><span>sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Give it permission to execute</span>
</span></span><span style="display:flex;"><span>sudo chmod +x /usr/local/bin/gitlab-runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Create a GitLab Runner user</span>
</span></span><span style="display:flex;"><span>sudo useradd --comment <span style="color:#0ff;font-weight:bold">&#39;GitLab Runner&#39;</span> --create-home gitlab-runner --shell /bin/bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Install and run as a service</span>
</span></span><span style="display:flex;"><span>sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner
</span></span><span style="display:flex;"><span>sudo gitlab-runner start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 注册</span>
</span></span><span style="display:flex;"><span>sudo gitlab-runner register --url http://mygitlab.com/ --registration-token M1jkqBfpuuzAnH9s7aYE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 删除</span>
</span></span><span style="display:flex;"><span>ljw@server:/etc$ sudo gitlab-runner verify --delete -t 7cEPwExkwMdD5_bU7ECh -u http://mygitlab.com/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 注册相同,注册一个shared类型的runner</span>
</span></span><span style="display:flex;"><span>ERRO[0000] Docker executor: prebuilt image helpers will be loaded from /var/lib/gitlab-runner.
</span></span><span style="display:flex;"><span>Running in system-mode.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/):
</span></span><span style="display:flex;"><span>[http://mygitlab.com/]:
</span></span><span style="display:flex;"><span>Please enter the gitlab-ci token <span style="color:#fff;font-weight:bold">for</span> this runner:
</span></span><span style="display:flex;"><span>[M1jkqBfpuuzAnH9s7aYE]:
</span></span><span style="display:flex;"><span>Please enter the gitlab-ci description <span style="color:#fff;font-weight:bold">for</span> this runner:
</span></span><span style="display:flex;"><span>[server]:
</span></span><span style="display:flex;"><span>Please enter the gitlab-ci tags <span style="color:#fff;font-weight:bold">for</span> this runner (comma separated):
</span></span><span style="display:flex;"><span>implement
</span></span><span style="display:flex;"><span>Registering runner... succeeded                     runner=M1jkqBfp
</span></span><span style="display:flex;"><span>Please enter the executor: ssh, virtualbox, docker+machine, docker-ssh+machine, docker-ssh, parallels, kubernetes, docker, shell:
</span></span><span style="display:flex;"><span>shell
</span></span><span style="display:flex;"><span>Runner registered successfully. Feel free to start it, but <span style="color:#fff;font-weight:bold">if</span> it<span style="color:#f00">&#39;</span>s running already the config should be automatically reloaded!
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/images/gitlab/image-20230109190131052.png" alt="image-20230109190131052"  />
</p>
<h4 id="docker安装">docker安装<a hidden class="anchor" aria-hidden="true" href="#docker安装">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 创建配置文件挂在目录</span>
</span></span><span style="display:flex;"><span>ljw@server:~$ mkdir gitlab_runner_config
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 启动容器</span>
</span></span><span style="display:flex;"><span>ljw@server:~$ sudo docker run -d --name gitlab-runner --restart always     -v /var/run/docker.so^C:/var/run/docker.sock     -v /home/ljw/gitlab_runner_config/:/etc/gitlab-runner gitlab/gitlab-runner:latest
</span></span><span style="display:flex;"><span>[sudo] password <span style="color:#fff;font-weight:bold">for</span> ljw:
</span></span><span style="display:flex;"><span>Unable to find image <span style="color:#0ff;font-weight:bold">&#39;gitlab/gitlab-runner:latest&#39;</span> locally
</span></span><span style="display:flex;"><span>latest: Pulling from gitlab/gitlab-runner
</span></span><span style="display:flex;"><span>846c0b181fff: Pull <span style="color:#fff;font-weight:bold">complete</span>
</span></span><span style="display:flex;"><span>f05423af2dfd: Pull <span style="color:#fff;font-weight:bold">complete</span>
</span></span><span style="display:flex;"><span>d92eb7aeb475: Pull <span style="color:#fff;font-weight:bold">complete</span>
</span></span><span style="display:flex;"><span>Digest: sha256:15a3945030802e20d24326aef1e60b69478336842db88069303ddfdfe9cebf9a
</span></span><span style="display:flex;"><span>Status: Downloaded newer image <span style="color:#fff;font-weight:bold">for</span> gitlab/gitlab-runner:latest
</span></span><span style="display:flex;"><span>6125256c41ce4dc86f54aac997b50a633b94a0c94209740a3dc3be9e4e0983b7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ljw@server:~$ sudo docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE                         COMMAND                  CREATED          STATUS          PORTS     NAMES
</span></span><span style="display:flex;"><span>6125256c41ce   gitlab/gitlab-runner:latest   <span style="color:#0ff;font-weight:bold">&#34;/usr/bin/dumb-init …&#34;</span>   <span style="color:#ff0;font-weight:bold">19</span> seconds ago   Up <span style="color:#ff0;font-weight:bold">17</span> seconds             gitlab-runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 新建一个测试项目，test</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 略</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 注册一个特定项目runner，为test,确保容器能解析到mygitlab.com</span>
</span></span><span style="display:flex;"><span>ljw@server:~$ sudo docker <span style="color:#fff;font-weight:bold">exec</span> -it gitlab-runner /bin/bash
</span></span><span style="display:flex;"><span>root@6125256c41ce:/# gitlab-runner register --url http://mygitlab.com/ --registration-token GR1348941sgKMG1cURqipSf8s7u7M
</span></span><span style="display:flex;"><span>Runtime platform                                    arch=amd64 os=linux pid=<span style="color:#ff0;font-weight:bold">56</span> revision=6d480948 version=15.7.1
</span></span><span style="display:flex;"><span>Running in system-mode.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enter the GitLab instance URL (<span style="color:#fff;font-weight:bold">for</span> example, https://gitlab.com/):
</span></span><span style="display:flex;"><span>[http://mygitlab.com/]:
</span></span><span style="display:flex;"><span>Enter the registration token:
</span></span><span style="display:flex;"><span>[GR1348941sgKMG1cURqipSf8s7u7M]:
</span></span><span style="display:flex;"><span>Enter a description <span style="color:#fff;font-weight:bold">for</span> the runner:
</span></span><span style="display:flex;"><span>[6125256c41ce]:
</span></span><span style="display:flex;"><span>Enter tags <span style="color:#fff;font-weight:bold">for</span> the runner (comma-separated):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enter optional maintenance note <span style="color:#fff;font-weight:bold">for</span> the runner:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>WARNING: Support <span style="color:#fff;font-weight:bold">for</span> registration tokens and runner parameters in the <span style="color:#0ff;font-weight:bold">&#39;register&#39;</span> <span style="color:#fff;font-weight:bold">command</span> has been deprecated in GitLab Runner 15.6 and will be replaced with support <span style="color:#fff;font-weight:bold">for</span> authentication tokens. For more information, see https://gitlab.com/gitlab-org/gitlab/-/issues/380872
</span></span><span style="display:flex;"><span>Registering runner... succeeded                     runner=GR1348941sgKMG1cU
</span></span><span style="display:flex;"><span>Enter an executor: kubernetes, custom, docker, parallels, shell, ssh, docker+machine, instance, docker-ssh, virtualbox, docker-ssh+machine:
</span></span><span style="display:flex;"><span>shell
</span></span><span style="display:flex;"><span>Runner registered successfully. Feel free to start it, but <span style="color:#fff;font-weight:bold">if</span> it<span style="color:#f00">&#39;</span>s running already the config should be automatically reloaded!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Configuration (with the authentication token) was saved in <span style="color:#0ff;font-weight:bold">&#34;/etc/gitlab-runner/config.toml&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/images/gitlab/image-20230109194543239.png" alt="image-20230109194543239"  />
</p>
<h2 id="四cicd流水线">四、CICD流水线<a hidden class="anchor" aria-hidden="true" href="#四cicd流水线">#</a></h2>
<h3 id="1基本使用">1.基本使用<a hidden class="anchor" aria-hidden="true" href="#1基本使用">#</a></h3>
<ul>
<li>创建项目test</li>
</ul>
<p>​	<img loading="lazy" src="/images/gitlab/image-20230110101533710.png" alt="image-20230110101533710"  />
</p>
<ul>
<li>项目根目录下创建流水线文件.gitlab-ci.yml</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages:          <span style="color:#007f7f"># List of stages for jobs, and their order of execution</span>
</span></span><span style="display:flex;"><span>  - build
</span></span><span style="display:flex;"><span>  - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>  - deploy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build-job:       <span style="color:#007f7f"># This job runs in the build stage, which runs first.</span>
</span></span><span style="display:flex;"><span>  stage: build
</span></span><span style="display:flex;"><span>  script:
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;Compiling the code...&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;Compile complete.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>unit-test-job:   <span style="color:#007f7f"># This job runs in the test stage.</span>
</span></span><span style="display:flex;"><span>  stage: <span style="color:#fff;font-weight:bold">test</span>    <span style="color:#007f7f"># It only starts when the job in the build stage completes successfully.</span>
</span></span><span style="display:flex;"><span>  script:
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;Running unit tests... This will take about 60 seconds.&#34;</span>
</span></span><span style="display:flex;"><span>    - sleep <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;Code coverage is 90%&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lint-test-job:   <span style="color:#007f7f"># This job also runs in the test stage.</span>
</span></span><span style="display:flex;"><span>  stage: <span style="color:#fff;font-weight:bold">test</span>    <span style="color:#007f7f"># It can run at the same time as unit-test-job (in parallel).</span>
</span></span><span style="display:flex;"><span>  script:
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;Linting code... This will take about 10 seconds.&#34;</span>
</span></span><span style="display:flex;"><span>    - sleep <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;No lint issues found.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deploy-job:      <span style="color:#007f7f"># This job runs in the deploy stage.</span>
</span></span><span style="display:flex;"><span>  stage: deploy  <span style="color:#007f7f"># It only runs when *both* jobs in the test stage complete successfully.</span>
</span></span><span style="display:flex;"><span>  environment: production
</span></span><span style="display:flex;"><span>  script:
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;Deploying application...&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;Application successfully deployed.&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>每一次修改都会触发流水线</p>
<p><img loading="lazy" src="/images/gitlab/image-20230110102803181.png" alt="image-20230110102803181"  />
</p>
</li>
<li>
<p>可点击某一次流水线查看执行详情</p>
</li>
</ul>
<blockquote>
<p>pipeline文件中定义了三个阶段，build，test，deploy，可分别查看</p>
</blockquote>
<p>​	<img loading="lazy" src="/images/gitlab/image-20230110103049970.png" alt="image-20230110103049970"  />
</p>
<h3 id="2流水线语法检测">2.流水线语法检测<a hidden class="anchor" aria-hidden="true" href="#2流水线语法检测">#</a></h3>
<ul>
<li>使用CI lint 检查pipeline文件语法是否正确，然后再修改仓库文件</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230110103902318.png" alt="image-20230110103902318"  />
</p>
<p><img loading="lazy" src="/images/gitlab/image-20230110103838136.png" alt="image-20230110103838136"  />
</p>
<h3 id="3pipeline语法">3.pipeline语法<a hidden class="anchor" aria-hidden="true" href="#3pipeline语法">#</a></h3>
<h4 id="关键字概览">关键字概览<a hidden class="anchor" aria-hidden="true" href="#关键字概览">#</a></h4>
<table>
<thead>
<tr>
<th>关键词</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>job</td>
<td>pipeline文件中由多个作业组成，每个作业必须有一个script，名字必须唯一</td>
</tr>
<tr>
<td>script</td>
<td>指定具体的操作，现在是shell语句</td>
</tr>
<tr>
<td>before_script</td>
<td>作业运行之前要做的操作，如果是全局的，每个作业都会执行</td>
</tr>
<tr>
<td>after_script</td>
<td>作业运行之后要做的操作，如果是全局的，每个作业都会执行</td>
</tr>
<tr>
<td>stages</td>
<td>控制stage的顺序，一个stage可能执行多个作业</td>
</tr>
<tr>
<td>stage</td>
<td>指定当前是哪个stage，两个关键字：.pre为第一个运行，.post为最后运行</td>
</tr>
<tr>
<td>variables</td>
<td>定义变量</td>
</tr>
<tr>
<td>tags</td>
<td>指定runner</td>
</tr>
<tr>
<td>allow_failure</td>
<td>允许失败，默认值为false</td>
</tr>
<tr>
<td>when</td>
<td>控制作业执行条件</td>
</tr>
<tr>
<td>retry</td>
<td>重试次数</td>
</tr>
<tr>
<td>timeout</td>
<td>超时时间</td>
</tr>
<tr>
<td>parallel</td>
<td>并行作业实例数，2&lt;x&lt;50，创建n个运行同一作业</td>
</tr>
<tr>
<td>only</td>
<td>限制哪些分支和tag会被job执行</td>
</tr>
<tr>
<td>except</td>
<td>限制哪些分支和tag不会被job执行</td>
</tr>
<tr>
<td>rules</td>
<td>构建规则，按顺序匹配为作业提供属性</td>
</tr>
<tr>
<td>workflow</td>
<td>适用于整个管道是否创建</td>
</tr>
<tr>
<td>cache</td>
<td>存储编译时所需要的运行时依赖项，指定项目空间中需要在job之间缓存的文件/目录，可全局定义或局部定义</td>
</tr>
<tr>
<td>artifacts</td>
<td>制品，作业成功或失败时附加到作业的文件或目录列表，作业完成后发送到gitlab&lt;br /</td>
</tr>
<tr>
<td>dependencies</td>
<td>使用制品</td>
</tr>
<tr>
<td>needs</td>
<td>阶段并行，适用于执行无序的作业</td>
</tr>
<tr>
<td>include</td>
<td>引用配置</td>
</tr>
<tr>
<td>extends</td>
<td>继承作业配置，从模版中继承，新定义的则不继承，其他的全部继承</td>
</tr>
<tr>
<td>trigger</td>
<td>触发器，触发别的管道</td>
</tr>
<tr>
<td>image</td>
<td>指定docker excutor的镜像</td>
</tr>
<tr>
<td>services</td>
<td>依赖镜像服务</td>
</tr>
<tr>
<td>inherit</td>
<td>是否使用定义的全局变量</td>
</tr>
<tr>
<td>environment</td>
<td>指定发布环境</td>
</tr>
</tbody>
</table>
<h4 id="基本关键字使用">基本关键字使用<a hidden class="anchor" aria-hidden="true" href="#基本关键字使用">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 编写案例</span>
</span></span><span style="display:flex;"><span>before_script:    <span style="color:#007f7f"># 执行前动作</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;this is global before script&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    - deploy
</span></span><span style="display:flex;"><span>    - clean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - sleep <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>    after_script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;this is after build script&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;this is test </span>$Version<span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>deploy:
</span></span><span style="display:flex;"><span>    stage: deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;deploying&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clean:
</span></span><span style="display:flex;"><span>    stage: .post
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;clean environment&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>更新pipeline文件观察执行结果</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230110113239589.png" alt="image-20230110113239589"  />
</p>
<p><img loading="lazy" src="/images/gitlab/image-20230110113403511.png" alt="image-20230110113403511"  />
</p>
<p><img loading="lazy" src="/images/gitlab/image-20230110113446526.png" alt="image-20230110113446526"  />
</p>
<h4 id="tagsallow_failurewhenretrytimeoutparallel">tags、allow_failure、when、retry、timeout、parallel<a hidden class="anchor" aria-hidden="true" href="#tagsallow_failurewhenretrytimeoutparallel">#</a></h4>
<table>
<thead>
<tr>
<th>关键字</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>tags</td>
<td>指定runner</td>
</tr>
<tr>
<td>allow_failure</td>
<td>允许失败，默认值为false</td>
</tr>
<tr>
<td>when</td>
<td>控制作业执行；<br />on_success:前面阶段成功才执行，<br />on_failure:前面阶段出现失败时执行<br />always:总是执行<br />manual:手动<br />delayed:延迟执行</td>
</tr>
<tr>
<td>retry</td>
<td>重试次数</td>
</tr>
<tr>
<td>timeout</td>
<td>超时时间</td>
</tr>
<tr>
<td>parallel</td>
<td>并行作业实例数，2&lt;x&lt;50，创建n个运行同一作业</td>
</tr>
</tbody>
</table>
<ul>
<li>编写测试案例</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 编写案例</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    - deploy
</span></span><span style="display:flex;"><span>    - clean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - sleep <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>        - eho <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>    after_script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;this is after build script&#34;</span>
</span></span><span style="display:flex;"><span>    allow_failure: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    retry: <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - eho <span style="color:#0ff;font-weight:bold">&#34;this is test </span>$Version<span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>deploy:
</span></span><span style="display:flex;"><span>    stage: deploy
</span></span><span style="display:flex;"><span>    tags: 
</span></span><span style="display:flex;"><span>        - implement
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;deploying&#34;</span>
</span></span><span style="display:flex;"><span>    timeout: <span style="color:#ff0;font-weight:bold">1</span> minute
</span></span><span style="display:flex;"><span>    when: on_failure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clean:
</span></span><span style="display:flex;"><span>    stage: .post
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;clean environment&#34;</span>
</span></span><span style="display:flex;"><span>    parallel: <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>    when: on_failure
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>运行结果：
<ul>
<li>build三次都失败但是忽略，</li>
<li>test失败，</li>
<li>deploy指定shared runner，</li>
<li>deploy和clean都是on_failure执行，因此会执行</li>
</ul>
</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230110195442471.png" alt="image-20230110195442471"  />
</p>
<p><img loading="lazy" src="/images/gitlab/image-20230110195539636.png" alt="image-20230110195539636"  />
</p>
<h4 id="onlyexceptrulesworkflow">only,except,rules,workflow<a hidden class="anchor" aria-hidden="true" href="#onlyexceptrulesworkflow">#</a></h4>
<table>
<thead>
<tr>
<th>关键字</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>only</td>
<td>限制哪些分支和tag会被job执行</td>
</tr>
<tr>
<td>except</td>
<td>限制哪些分支和tag不会被job执行</td>
</tr>
<tr>
<td>rules</td>
<td>构建规则，按顺序匹配为作业提供属性<br />if（如果条件匹配）<br />changes（如果条件发生改变）<br />exists（指定文件存在）</td>
</tr>
<tr>
<td>workflow</td>
<td>适用于整个管道是否创建</td>
</tr>
</tbody>
</table>
<ul>
<li>案例</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 编写案例</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    Domain: a.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow:           <span style="color:#007f7f"># a.com则创建pipeline</span>
</span></span><span style="display:flex;"><span>    rules:
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">if</span>: $Domain == <span style="color:#0ff;font-weight:bold">&#34;a.com&#34;</span>
</span></span><span style="display:flex;"><span>      when: always
</span></span><span style="display:flex;"><span>    - when: never 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    - deploy
</span></span><span style="display:flex;"><span>    - clean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - sleep <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>    after_script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;this is after build script&#34;</span>
</span></span><span style="display:flex;"><span>    allow_failure: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    retry: <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test:     <span style="color:#007f7f"># main分支才执行test</span>
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;this is test </span>$Version<span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>    only: 
</span></span><span style="display:flex;"><span>        - main
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>deploy:     <span style="color:#007f7f"># develop分支不执行这一步</span>
</span></span><span style="display:flex;"><span>    stage: deploy
</span></span><span style="display:flex;"><span>    tags: 
</span></span><span style="display:flex;"><span>        - implement
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;deploying&#34;</span>
</span></span><span style="display:flex;"><span>    timeout: <span style="color:#ff0;font-weight:bold">1</span> minute
</span></span><span style="display:flex;"><span>    except:
</span></span><span style="display:flex;"><span>        - develop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clean:
</span></span><span style="display:flex;"><span>    stage: .post
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;clean environment&#34;</span>
</span></span><span style="display:flex;"><span>    parallel: <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>    rules:    <span style="color:#007f7f"># 存在jenkinsFile才会有这一阶段</span>
</span></span><span style="display:flex;"><span>        - exists: 
</span></span><span style="display:flex;"><span>            - jenkinsFile
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>执行结果</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230112110535834.png" alt="image-20230112110535834"  />
</p>
<h4 id="cacheartifactsdependencies">cache,artifacts,dependencies<a hidden class="anchor" aria-hidden="true" href="#cacheartifactsdependencies">#</a></h4>
<table>
<thead>
<tr>
<th>关键字</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>cache</td>
<td>存储编译时所需要的运行时依赖项，指定项目空间中需要在job之间缓存的文件/目录，可全局定义或局部定义<br />paths：指定缓存目录/文件<br />key:标识缓存<br />key:files:文件变化自动创建缓存，files最多指定两个文件<br />prefix:允许给定prefix的值与指定文件生成密钥组合<br />policy:缓存策略，默认在开始时下载文件，在结束时上传文件，设置为pull跳过下载步骤，设置为push跳过上传步骤</td>
</tr>
<tr>
<td>artifacts</td>
<td>制品，作业成功或失败时附加到作业的文件或目录列表，作业完成后发送到gitlab<br />paths：收集文件或者目录<br />expose_as:展示在ui的名称<br />name:制品名称,可以使用变量，如$CI_JOB_NAME<br />when:制品创建条件<br />expire_in:制品保留时间<br />reports:junit:单元测试报告<br />reports:cobertura:覆盖率</td>
</tr>
<tr>
<td>dependencies</td>
<td>使用制品</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>cache默认缓存策略</p>
<p><img loading="lazy" src="/images/gitlab/image-20230113103649401.png" alt="image-20230113103649401"  />
</p>
<ul>
<li>
<p>缓存案例</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>	<span style="color:#007f7f"># 编写案例    </span>
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    Domain: a.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow:
</span></span><span style="display:flex;"><span>    rules:
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">if</span>: $Domain == <span style="color:#0ff;font-weight:bold">&#34;a.com&#34;</span>
</span></span><span style="display:flex;"><span>      when: always
</span></span><span style="display:flex;"><span>    - when: never 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache:
</span></span><span style="display:flex;"><span>    paths:
</span></span><span style="display:flex;"><span>        - target/      <span style="color:#007f7f"># 缓存target目录</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    - deploy
</span></span><span style="display:flex;"><span>    - clean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>        - implement
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - ls
</span></span><span style="display:flex;"><span>        - id
</span></span><span style="display:flex;"><span>        - mkdir target
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>    after_script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;this is after build script&#34;</span>
</span></span><span style="display:flex;"><span>    allow_failure: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    retry: <span style="color:#ff0;font-weight:bold">2</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - implement
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;run test </span>$Version<span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#fff;font-weight:bold">test</span> &gt;&gt; target/a.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    only: 
</span></span><span style="display:flex;"><span>        - main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deploy: 
</span></span><span style="display:flex;"><span>    stage: deploy
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;deploying&#34;</span>
</span></span><span style="display:flex;"><span>        - cat target/a.txt
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;deploy success&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clean:
</span></span><span style="display:flex;"><span>    stage: .post
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;clean environment&#34;</span>
</span></span><span style="display:flex;"><span>    parallel: <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>    rules:
</span></span><span style="display:flex;"><span>        - exists: 
</span></span><span style="display:flex;"><span>            - jenkinsFile
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>执行结果分析</p>
<ul>
<li>
<p>cache默认存放在家目录</p>
</li>
<li>
<p>build阶段：下载上一次的缓存，执行结束后生成缓存，都存在本地家目录
<img loading="lazy" src="/images/gitlab/image-20230113134343022.png" alt="image-20230113134343022"  />
</p>
</li>
<li>
<p>test阶段：检出分支，删掉本地的target，加载缓存，执行完保存缓存</p>
<p><img loading="lazy" src="/images/gitlab/image-20230113134536955.png" alt="image-20230113134536955"  />
</p>
</li>
<li>
<p>deploy阶段：已经保存的上次的缓存可以直接查看内容</p>
<p><img loading="lazy" src="/images/gitlab/image-20230113134735053.png" alt="image-20230113134735053"  />
</p>
</li>
</ul>
</li>
<li>
<p>制品案例</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 编写案例    </span>
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    Domain: a.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow:
</span></span><span style="display:flex;"><span>    rules:
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">if</span>: $Domain == <span style="color:#0ff;font-weight:bold">&#34;a.com&#34;</span>
</span></span><span style="display:flex;"><span>      when: always
</span></span><span style="display:flex;"><span>    - when: never 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    - deploy
</span></span><span style="display:flex;"><span>    - clean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - ls
</span></span><span style="display:flex;"><span>        - id
</span></span><span style="display:flex;"><span>        - mkdir target
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>    after_script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;this is after build script&#34;</span>
</span></span><span style="display:flex;"><span>    allow_failure: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    retry: <span style="color:#ff0;font-weight:bold">2</span>  
</span></span><span style="display:flex;"><span>    artifacts:
</span></span><span style="display:flex;"><span>        paths:
</span></span><span style="display:flex;"><span>            - target/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;run test </span>$Version<span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#fff;font-weight:bold">test</span> &gt;&gt; target/a.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    only: 
</span></span><span style="display:flex;"><span>        - main
</span></span><span style="display:flex;"><span>    artifacts:
</span></span><span style="display:flex;"><span>        paths:
</span></span><span style="display:flex;"><span>            - target/
</span></span><span style="display:flex;"><span>        expose_as: target_file
</span></span><span style="display:flex;"><span>        name: a.txt
</span></span><span style="display:flex;"><span>        when: on_success
</span></span><span style="display:flex;"><span>    dependencies:
</span></span><span style="display:flex;"><span>        - build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deploy: 
</span></span><span style="display:flex;"><span>    stage: deploy
</span></span><span style="display:flex;"><span>    dependencies:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;deploying&#34;</span>
</span></span><span style="display:flex;"><span>        - cat target/a.txt
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;deploy success&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clean:
</span></span><span style="display:flex;"><span>    stage: .post
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;clean environment&#34;</span>
</span></span><span style="display:flex;"><span>    parallel: <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>    rules:
</span></span><span style="display:flex;"><span>        - exists: 
</span></span><span style="display:flex;"><span>            - jenkinsFile
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在job中可以看到上传制品，并且可以直接浏览下载</p>
</li>
</ul>
</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230114100625209.png" alt="image-20230114100625209"  />
</p>
<h4 id="needs">needs<a hidden class="anchor" aria-hidden="true" href="#needs">#</a></h4>
<ul>
<li>阶段并行，适用于执行无序的作业</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 原始效果，AB两个build都结束才可以执行AB两个test</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># needs实现A执行完就可以执行A的test，节省时间</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 编写案例    </span>
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    Domain: a.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow:
</span></span><span style="display:flex;"><span>    rules:
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">if</span>: $Domain == <span style="color:#0ff;font-weight:bold">&#34;a.com&#34;</span>
</span></span><span style="display:flex;"><span>      when: always
</span></span><span style="display:flex;"><span>    - when: never 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    - deploy
</span></span><span style="display:flex;"><span>    - clean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build A:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - ls
</span></span><span style="display:flex;"><span>        - id
</span></span><span style="display:flex;"><span>        - mkdir target
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>        - sleep <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>    after_script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;this is after build script&#34;</span>
</span></span><span style="display:flex;"><span>    allow_failure: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    retry: <span style="color:#ff0;font-weight:bold">2</span>  
</span></span><span style="display:flex;"><span>    artifacts:
</span></span><span style="display:flex;"><span>        paths:
</span></span><span style="display:flex;"><span>            - target/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build B:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - ls
</span></span><span style="display:flex;"><span>        - id
</span></span><span style="display:flex;"><span>        - mkdir target
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>        - sleep <span style="color:#ff0;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>    after_script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;this is after build script&#34;</span>
</span></span><span style="display:flex;"><span>    allow_failure: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    retry: <span style="color:#ff0;font-weight:bold">2</span>  
</span></span><span style="display:flex;"><span>    artifacts:
</span></span><span style="display:flex;"><span>        paths:
</span></span><span style="display:flex;"><span>            - target/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">test</span> A:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;run test </span>$Version<span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#fff;font-weight:bold">test</span> &gt;&gt; target/a.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    only: 
</span></span><span style="display:flex;"><span>        - main
</span></span><span style="display:flex;"><span>    needs:
</span></span><span style="display:flex;"><span>        - job: build A
</span></span><span style="display:flex;"><span>          artifacts: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">test</span> B:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;run test </span>$Version<span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#fff;font-weight:bold">test</span> &gt;&gt; target/a.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    only: 
</span></span><span style="display:flex;"><span>        - main
</span></span><span style="display:flex;"><span>    needs:
</span></span><span style="display:flex;"><span>        - job: build B
</span></span><span style="display:flex;"><span>          artifacts: <span style="color:#fff;font-weight:bold">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>include引用</p>
<ul>
<li>local：引用同一存储库中的文件，使用相对于根目录的完整路径进行引用</li>
<li>file:引用其他项目配置</li>
<li>template：引用官方模版</li>
<li>remote：远程文件地址</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 创建CI文件夹，存放引用文件</span>
</span></span><span style="display:flex;"><span>ci/local.yml
</span></span><span style="display:flex;"><span>deploy:
</span></span><span style="display:flex;"><span>    stage: deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span>  deploy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 编写案例    </span>
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    Domain: a.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow:
</span></span><span style="display:flex;"><span>    rules:
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">if</span>: $Domain == <span style="color:#0ff;font-weight:bold">&#34;a.com&#34;</span>
</span></span><span style="display:flex;"><span>      when: always
</span></span><span style="display:flex;"><span>    - when: never 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>include:
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># local: ci/local.yml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># remote 要能获取到</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># remote: &#39;http://mygitlab.com/gitlab-instance-77485aca/test/-/raw/main/ci/local.yml&#39;</span>
</span></span><span style="display:flex;"><span>    - project: <span style="color:#0ff;font-weight:bold">&#39;gitlab-instance-77485aca/test&#39;</span>
</span></span><span style="display:flex;"><span>      file: ci/local.yml
</span></span><span style="display:flex;"><span>      ref: main
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># template: Auto-DevOps.gitlab-ci.yml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    - deploy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build A:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - ls
</span></span><span style="display:flex;"><span>        - id
</span></span><span style="display:flex;"><span>        - mkdir target
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">test</span> A:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;run test </span>$Version<span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/images/gitlab/image-20230114110536452.png" alt="image-20230114110536452"  />
</p>
</li>
<li>
<p>extends：继承作业配置，从模版中继承，新定义的则不继承，其他的全部继承</p>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 案例：使用extends继承了属性，test阶段直接被跳过，因为前一个任务执行失败才会执行</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 编写案例    </span>
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    Domain: a.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow:
</span></span><span style="display:flex;"><span>    rules:
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">if</span>: $Domain == <span style="color:#0ff;font-weight:bold">&#34;a.com&#34;</span>
</span></span><span style="display:flex;"><span>      when: always
</span></span><span style="display:flex;"><span>    - when: never 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>common:
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - ehco this is script
</span></span><span style="display:flex;"><span>    when: on_failure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build A:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - ls
</span></span><span style="display:flex;"><span>        - id
</span></span><span style="display:flex;"><span>        - mkdir target
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">test</span> A:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    extends: common
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;run test </span>$Version<span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/images/gitlab/image-20230114152457229.png" alt="image-20230114152457229"  />
</p>
<ul>
<li>
<p>trigger：触发器</p>
<ul>
<li>从trigger定义创建的作业启动时将创建一个下游管道</li>
<li>允许创建多项目管道和子管道</li>
<li>trigger与when：manual一起时会出错</li>
<li>多项目管道：一个项目中的管道可以触发其他项目中的管道（微服务架构）</li>
<li>父子管道：在项目中触发一组同时运行的管道，不受父管道进度限制</li>
<li>多项目管道实例</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 创建项目test2并设置pipeline</span>
</span></span><span style="display:flex;"><span>stages:
</span></span><span style="display:flex;"><span>    - deploy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deploy:
</span></span><span style="display:flex;"><span>    stage: deploy
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;test2 deploying&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 在test中使用trigger触发test2的管道</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 编写案例    </span>
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    Domain: a.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - deploy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build A:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deploy:
</span></span><span style="display:flex;"><span>    stage: deploy
</span></span><span style="display:flex;"><span>    trigger:
</span></span><span style="display:flex;"><span>        project: gitlab-instance-77485aca/test2
</span></span><span style="display:flex;"><span>        branch: main
</span></span><span style="display:flex;"><span>        strategy: depend
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/images/gitlab/image-20230114160319770.png" alt="image-20230114160319770"  />
</p>
<ul>
<li>父子项目管道实例</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 编写案例    </span>
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    Domain: a.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - deploy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build A:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deploy:
</span></span><span style="display:flex;"><span>    stage: deploy
</span></span><span style="display:flex;"><span>    trigger:
</span></span><span style="display:flex;"><span>        include: ci/local.yml   <span style="color:#007f7f"># 创建子管道</span>
</span></span><span style="display:flex;"><span>        strategy: depend   <span style="color:#007f7f"># 子管道执行完父管道才算执行结束，继续下面的执行</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/images/gitlab/image-20230114155407347.png" alt="image-20230114155407347"  />
</p>
</li>
</ul>
<h4 id="imageservices">image/services<a hidden class="anchor" aria-hidden="true" href="#imageservices">#</a></h4>
<ul>
<li>image：docker执行器需要制定镜像，所有的操作都会在容器中执行，job中指定镜像优先级高于runner镜像</li>
<li>service:依赖服务，后面构建过程中可以直接使用</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 创建docker执行器，指定镜像为alpine:latest</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 设置镜像拉取策略,因为我使用的是主机名解析，要确保容器也能访问到gitlab，因此我将宿主机的hosts文件挂在进容器</span>
</span></span><span style="display:flex;"><span>ljw@server:~$ sudo grep  -C2 pull_policy /etc/gitlab-runner/config.toml
</span></span><span style="display:flex;"><span>    [runners.cache.azure]
</span></span><span style="display:flex;"><span>  [runners.docker]
</span></span><span style="display:flex;"><span>    pull_policy = <span style="color:#0ff;font-weight:bold">&#34;if-not-present&#34;</span>
</span></span><span style="display:flex;"><span>    tls_verify = <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    image = <span style="color:#0ff;font-weight:bold">&#34;alpine:latest&#34;</span>
</span></span><span style="display:flex;"><span>    volumes = [<span style="color:#0ff;font-weight:bold">&#34;/etc/hosts:/etc/hosts:rw&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;/cache&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建测试pipeline</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    Domain: a.com
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>services:
</span></span><span style="display:flex;"><span>		- name: redis:latest
</span></span><span style="display:flex;"><span>		  alias: myredis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build A:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - docker
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/images/gitlab/image-20230115183844630.png" alt="image-20230115183844630"  />
</p>
<h4 id="environment">environment<a hidden class="anchor" aria-hidden="true" href="#environment">#</a></h4>
<ul>
<li>指定作业发布，方便ui统一管理环境的发布记录以及重新发布等</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>variables:  <span style="color:#007f7f"># 变量定义</span>
</span></span><span style="display:flex;"><span>    Version: <span style="color:#0ff;font-weight:bold">&#34;16.2&#34;</span>
</span></span><span style="display:flex;"><span>    Domain: a.com
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>stages: <span style="color:#007f7f"># 定义阶段运行顺序</span>
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build A:  <span style="color:#007f7f"># job名字为build</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - docker
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;start build&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;build success&#34;</span>
</span></span><span style="display:flex;"><span>    environment:
</span></span><span style="display:flex;"><span>          name: production   <span style="color:#007f7f"># 指明生产环境</span>
</span></span><span style="display:flex;"><span>          url: http:www.baidu.com  <span style="color:#007f7f"># 为生产环境指定一个url</span>
</span></span><span style="display:flex;"><span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/images/gitlab/image-20230115185136132.png" alt="image-20230115185136132"  />
				<img loading="lazy" src="/images/gitlab/image-20230115185224515.png" alt="image-20230115185224515"  />
</p>
<h4 id="inherit">inherit<a hidden class="anchor" aria-hidden="true" href="#inherit">#</a></h4>
<ul>
<li>是否使用定义的全局变量</li>
</ul>
<h3 id="4模版库规划">4.模版库规划<a hidden class="anchor" aria-hidden="true" href="#4模版库规划">#</a></h3>
<ul>
<li>1.创建一个git仓库ci存放模版</li>
<li>2.templates目录存放pipeline模版</li>
<li>3.jobs目录存放job模版</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230116202540946.png" alt="image-20230116202540946"  />
</p>
<h2 id="五工具链继承">五、工具链继承<a hidden class="anchor" aria-hidden="true" href="#五工具链继承">#</a></h2>
<h3 id="1maven集成">1.Maven集成<a hidden class="anchor" aria-hidden="true" href="#1maven集成">#</a></h3>
<ul>
<li>安装maven环境，maven是java项目的构建打包工具</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 安装不用多说</span>
</span></span><span style="display:flex;"><span>ljw@server:~$ mvn -v
</span></span><span style="display:flex;"><span>Apache Maven 3.6.3
</span></span><span style="display:flex;"><span>Maven home: /usr/share/maven
</span></span><span style="display:flex;"><span>Java version: 1.8.0_341, vendor: Oracle Corporation, runtime: /home/ljw/tools/jdk1.8.0_341/jre
</span></span><span style="display:flex;"><span>Default locale: en_US, platform encoding: UTF-8
</span></span><span style="display:flex;"><span>OS name: <span style="color:#0ff;font-weight:bold">&#34;linux&#34;</span>, version: <span style="color:#0ff;font-weight:bold">&#34;5.4.0-136-generic&#34;</span>, arch: <span style="color:#0ff;font-weight:bold">&#34;amd64&#34;</span>, family: <span style="color:#0ff;font-weight:bold">&#34;unix&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>创建build作业模版</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># jobs目录下新建build.yml</span>
</span></span><span style="display:flex;"><span>.build:   <span style="color:#007f7f"># 加.作为模版为下面继承</span>
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - build
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - $build_shell
</span></span><span style="display:flex;"><span>        - ls
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>创建pipeline模版</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 在templates目录下新建java-common.yml</span>
</span></span><span style="display:flex;"><span>include:
</span></span><span style="display:flex;"><span>    project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/build.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variables:
</span></span><span style="display:flex;"><span>    build_shell: <span style="color:#0ff;font-weight:bold">&#39;mvn clean package -DskipTests&#39;</span>
</span></span><span style="display:flex;"><span>    cache_dir: target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache:
</span></span><span style="display:flex;"><span>    paths:
</span></span><span style="display:flex;"><span>        - $cache_dir
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build:
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    extends: .build
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>创建一个maven项目</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 直接import gitee中的jtimer项目</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 增加pipeline文件</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/images/gitlab/image-20230116211558251.png" alt="image-20230116211558251"  />
</p>
<ul>
<li>进行扩展，在jobs加入test.yml</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>.test:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - build
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - $test_shell
</span></span><span style="display:flex;"><span>    artifacts:
</span></span><span style="display:flex;"><span>        paths: 
</span></span><span style="display:flex;"><span>            - $result
</span></span><span style="display:flex;"><span>        reports:
</span></span><span style="display:flex;"><span>            junit: target/surefire-reports/TEST-*.yml
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>将test加到java的pipeline模版中</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>include:
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/build.yml
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/test.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variables:
</span></span><span style="display:flex;"><span>    build_shell: <span style="color:#0ff;font-weight:bold">&#39;mvn clean package -DskipTests&#39;</span>
</span></span><span style="display:flex;"><span>    test_shell: <span style="color:#0ff;font-weight:bold">&#39;mvn test &#39;</span>
</span></span><span style="display:flex;"><span>    cache_dir: target
</span></span><span style="display:flex;"><span>    result: target/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache:
</span></span><span style="display:flex;"><span>    paths:
</span></span><span style="display:flex;"><span>        - $cache_dir
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages:
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build:
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    extends: .build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    extends: .test
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>更多的阶段都类似</li>
</ul>
<h3 id="2npm集成">2.Npm集成<a hidden class="anchor" aria-hidden="true" href="#2npm集成">#</a></h3>
<ul>
<li>
<p>创建一个npm项目,直接找一个开源项目import，我使用若依的前端‘</p>
</li>
<li>
<p>在ci项目template目录下创建npm-common.yml用作npm模版文件</p>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>include:
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/build.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages:
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variables:
</span></span><span style="display:flex;"><span>    build_shell: <span style="color:#0ff;font-weight:bold">&#34;npm run build:prod&#34;</span>   <span style="color:#007f7f"># package.json中定义了构建脚本</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build:
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    before_script:
</span></span><span style="display:flex;"><span>        - npm install    <span style="color:#007f7f"># npm项目需要安装依赖</span>
</span></span><span style="display:flex;"><span>    extends: .build
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>在项目下新建pipeline文件</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>include:
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: templates/npm-common.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>image:
</span></span><span style="display:flex;"><span>  name: node:16
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>构建成功</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230124184931180.png" alt="image-20230124184931180"  />
</p>
<p><img loading="lazy" src="/images/gitlab/image-20230124185006271.png" alt="image-20230124185006271"  />
</p>
<ul>
<li>需要其他操作再进行扩展即可</li>
</ul>
<h3 id="3集成制品库">3.集成制品库<a hidden class="anchor" aria-hidden="true" href="#3集成制品库">#</a></h3>
<ul>
<li>直接使用docker安装artifactory进行集成</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo docker pull releases-docker.jfrog.io/jfrog/artifactory-oss:latest
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 参考https://www.jfrog.com/confluence/display/JFROG/Installing+Artifactory#114759846aa77ee5734e34d7b8d6fba728e7f646f   进行安装</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>artifactory是一个制品仓库，创建一个cidevops的仓库</p>
</li>
<li>
<p><img loading="lazy" src="/images/gitlab/image-20230126183824244.png" alt="image-20230126183824244"  />
使用账号密码/apikey/accesskey等方式可以进行接口操作，下面演示使用账号密码进行制品的上传</p>
</li>
</ul>
<blockquote>
<p>上传时可使用多级目录记录制品的应用，版本，分支，等等信息</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 在jobs中加入上传制品的步骤，此时jobs目录下新建upload.yml内容为</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.deploy_artifact:
</span></span><span style="display:flex;"><span>    stage: upload
</span></span><span style="display:flex;"><span>    tags: 
</span></span><span style="display:flex;"><span>        - build
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - curl -u$ArtifactoryUser:$ArtifactoryPass -X PUT <span style="color:#0ff;font-weight:bold">&#34;</span>$ArtifactoryUrl<span style="color:#0ff;font-weight:bold">/</span>$ArtifactoryName<span style="color:#0ff;font-weight:bold">/</span>$TargetFilePath<span style="color:#0ff;font-weight:bold">/</span>$TargetFileName<span style="color:#0ff;font-weight:bold">&#34;</span> -T $ArtifactoryPath
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>对于一些隐私数据可以在项目-&gt;设置-&gt;CICD中设置变量,这里设置Artifactory的账号密码</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230126101918908.png" alt="image-20230126101918908"  />
</p>
<ul>
<li>在java的模版中加入上传制品步骤</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>include:
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/build.yml
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/test.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/upload.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variables:
</span></span><span style="display:flex;"><span>    build_shell: <span style="color:#0ff;font-weight:bold">&#39;mvn clean package -DskipTests&#39;</span>
</span></span><span style="display:flex;"><span>    test_shell: <span style="color:#0ff;font-weight:bold">&#39;mvn test &#39;</span>
</span></span><span style="display:flex;"><span>    cache_dir: target
</span></span><span style="display:flex;"><span>    result: target
</span></span><span style="display:flex;"><span>    ArtifactoryPath: target/*.jar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># 上传制品库</span>
</span></span><span style="display:flex;"><span>    ArtifactoryUrl: http://192.168.0.14:8081/artifactory
</span></span><span style="display:flex;"><span>    ArtifactoryName: cidevops
</span></span><span style="display:flex;"><span>    TargetFilePath: <span style="color:#0ff;font-weight:bold">${</span>CI_PROJECT_NAMESPACE<span style="color:#0ff;font-weight:bold">}</span>/<span style="color:#0ff;font-weight:bold">${</span>CI_PROJECT_NAME<span style="color:#0ff;font-weight:bold">}</span>/<span style="color:#0ff;font-weight:bold">${</span>CI_COMMIT_REF_NAME<span style="color:#0ff;font-weight:bold">}</span>-<span style="color:#0ff;font-weight:bold">${</span>CI_COMMIT_SHA<span style="color:#0ff;font-weight:bold">}</span>-<span style="color:#0ff;font-weight:bold">${</span>CI_PIPELINE_NAME<span style="color:#0ff;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    TargetFileName: <span style="color:#0ff;font-weight:bold">${</span>CI_PROJECT_NAME<span style="color:#0ff;font-weight:bold">}</span>-<span style="color:#0ff;font-weight:bold">${</span>CI_COMMIT_REF_NAME<span style="color:#0ff;font-weight:bold">}</span>-<span style="color:#0ff;font-weight:bold">${</span>CI_COMMIT_SHA<span style="color:#0ff;font-weight:bold">}</span>-<span style="color:#0ff;font-weight:bold">${</span>CI_PIPELINE_NAME<span style="color:#0ff;font-weight:bold">}</span>.jar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache:
</span></span><span style="display:flex;"><span>    paths:
</span></span><span style="display:flex;"><span>        - $cache_dir
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    - upload
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build:
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    extends: .build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    extends: .test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deploy_artifact:
</span></span><span style="display:flex;"><span>    stage: upload
</span></span><span style="display:flex;"><span>    extends: .deploy_artifact
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>制品上传成功，目录结构为组/项目/分支等信息</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230126194746619.png" alt="image-20230126194746619"  />
</p>
<ul>
<li>
<p>download可以新建job</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># down_artifact.yml</span>
</span></span><span style="display:flex;"><span>.down_artifact:
</span></span><span style="display:flex;"><span>    stage: deploy
</span></span><span style="display:flex;"><span>    tags:
</span></span><span style="display:flex;"><span>        - build
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - curl -u{ArtifactoryUser}:<span style="color:#0ff;font-weight:bold">${</span>ArtifactoryPass<span style="color:#0ff;font-weight:bold">}</span> -O <span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">${</span>ArtifactoryUrl<span style="color:#0ff;font-weight:bold">}${</span>ArtifactoryName<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">/</span><span style="color:#0ff;font-weight:bold">${</span>TargetFilePath<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">/</span><span style="color:#0ff;font-weight:bold">${</span>TargetFileName<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="4镜像仓库集成">4.镜像仓库集成<a hidden class="anchor" aria-hidden="true" href="#4镜像仓库集成">#</a></h3>
<ul>
<li>通过DockerFile进行打包构建，再通过接口上传到镜像仓库</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 源代码中上传DockerFile</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 在upload.yml中</span>
</span></span><span style="display:flex;"><span>.docker-build:
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    tags: 
</span></span><span style="display:flex;"><span>        - docker-build  <span style="color:#007f7f"># runner上必须有docker，最好用shell executor</span>
</span></span><span style="display:flex;"><span>    script:
</span></span><span style="display:flex;"><span>        - docker login -u <span style="color:#0ff;font-weight:bold">${</span>CI_REGISTRY_USER<span style="color:#0ff;font-weight:bold">}</span> -p <span style="color:#0ff;font-weight:bold">${</span>CI_REGISTRY_PASS<span style="color:#0ff;font-weight:bold">}</span> <span style="color:#0ff;font-weight:bold">${</span>CI_REGISTRY<span style="color:#0ff;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        - dodcker build -t <span style="color:#0ff;font-weight:bold">${</span>IMAGE_NAME<span style="color:#0ff;font-weight:bold">}</span> -f <span style="color:#0ff;font-weight:bold">${</span>DOCKERFILE_PATH<span style="color:#0ff;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        - docker push <span style="color:#0ff;font-weight:bold">${</span>IMAGE_NAME<span style="color:#0ff;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        - docker rmi <span style="color:#0ff;font-weight:bold">${</span>IMAGE_NAME<span style="color:#0ff;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>此时的java-common.yml</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>include:
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/build.yml
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/test.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/down_artifact.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - project: devops/ci
</span></span><span style="display:flex;"><span>    ref: main
</span></span><span style="display:flex;"><span>    file: jobs/upload.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variables:
</span></span><span style="display:flex;"><span>    build_shell: <span style="color:#0ff;font-weight:bold">&#39;mvn clean package -DskipTests&#39;</span>
</span></span><span style="display:flex;"><span>    test_shell: <span style="color:#0ff;font-weight:bold">&#39;mvn test &#39;</span>
</span></span><span style="display:flex;"><span>    cache_dir: target
</span></span><span style="display:flex;"><span>    result: target
</span></span><span style="display:flex;"><span>    ArtifactoryPath: target/*.jar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># 上传制品库</span>
</span></span><span style="display:flex;"><span>    ArtifactoryUrl: http://192.168.0.14:8081/artifactory
</span></span><span style="display:flex;"><span>    ArtifactoryName: cidevops
</span></span><span style="display:flex;"><span>    TargetFilePath: <span style="color:#0ff;font-weight:bold">${</span>CI_PROJECT_NAMESPACE<span style="color:#0ff;font-weight:bold">}</span>/<span style="color:#0ff;font-weight:bold">${</span>CI_PROJECT_NAME<span style="color:#0ff;font-weight:bold">}</span>/<span style="color:#0ff;font-weight:bold">${</span>CI_COMMIT_REF_NAME<span style="color:#0ff;font-weight:bold">}</span>-<span style="color:#0ff;font-weight:bold">${</span>CI_COMMIT_SHA<span style="color:#0ff;font-weight:bold">}</span>-<span style="color:#0ff;font-weight:bold">${</span>CI_PIPELINE_NAME<span style="color:#0ff;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    TargetFileName: <span style="color:#0ff;font-weight:bold">${</span>CI_PROJECT_NAME<span style="color:#0ff;font-weight:bold">}</span>-<span style="color:#0ff;font-weight:bold">${</span>CI_COMMIT_REF_NAME<span style="color:#0ff;font-weight:bold">}</span>-<span style="color:#0ff;font-weight:bold">${</span>CI_COMMIT_SHA<span style="color:#0ff;font-weight:bold">}</span>-<span style="color:#0ff;font-weight:bold">${</span>CI_PIPELINE_NAME<span style="color:#0ff;font-weight:bold">}</span>.jar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># docker配置</span>
</span></span><span style="display:flex;"><span>    DOCKERFILE_PATH: <span style="color:#0ff;font-weight:bold">&#34;./Dockerfile&#34;</span>
</span></span><span style="display:flex;"><span>    CI_REGISTRY: ccr.ccs.tencentyun.com
</span></span><span style="display:flex;"><span>    REGISTRY_PATH: idevops
</span></span><span style="display:flex;"><span>    CI_REGISTRY_USER: <span style="color:#ff0;font-weight:bold">100018599267</span> 
</span></span><span style="display:flex;"><span>    CI_REGISTRY_PASS: ljw00000
</span></span><span style="display:flex;"><span>    VERSION: 1.0. <span style="color:#007f7f"># 这里只是实验，可以使用变量</span>
</span></span><span style="display:flex;"><span>    IMAGE_NAME: <span style="color:#0ff;font-weight:bold">${</span>CI_REGISTRY<span style="color:#0ff;font-weight:bold">}</span>/<span style="color:#0ff;font-weight:bold">${</span>REGISTRY_PATH<span style="color:#0ff;font-weight:bold">}</span>/<span style="color:#0ff;font-weight:bold">${</span>CI_PROJECT_NAME<span style="color:#0ff;font-weight:bold">}</span>:<span style="color:#0ff;font-weight:bold">${</span>VERSION<span style="color:#0ff;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache:
</span></span><span style="display:flex;"><span>    paths:
</span></span><span style="display:flex;"><span>        - $cache_dir
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stages:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    - build
</span></span><span style="display:flex;"><span>    - <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    - upload
</span></span><span style="display:flex;"><span>    - down
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>build:
</span></span><span style="display:flex;"><span>    stage: build
</span></span><span style="display:flex;"><span>    extends: .build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test:
</span></span><span style="display:flex;"><span>    stage: <span style="color:#fff;font-weight:bold">test</span>
</span></span><span style="display:flex;"><span>    extends: .test
</span></span><span style="display:flex;"><span>    allow_failure: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>down:
</span></span><span style="display:flex;"><span>    stage: down
</span></span><span style="display:flex;"><span>    extends: .down_artifact
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deploy_artifact:
</span></span><span style="display:flex;"><span>    stage: upload
</span></span><span style="display:flex;"><span>    extends: .deploy_artifact
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>upload_docker:
</span></span><span style="display:flex;"><span>    stage: upload
</span></span><span style="display:flex;"><span>    extends: .docker-build
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>此处使用腾讯云个人镜像仓库</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230127101802588.png" alt="image-20230127101802588"  />
</p>
<ul>
<li>简单编写Dockerfile</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>FROM openjdk:8-alpine
</span></span><span style="display:flex;"><span>ADD target/*.jar /app.jar
</span></span><span style="display:flex;"><span>ENTRYPOINT [<span style="color:#0ff;font-weight:bold">&#34;java&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;-jar&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;/app.jar&#34;</span>]
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>设置分布式缓存，目前阶段都是docker执行器，docker build在shell执行器比较方便，但是多个runner需要设置分布式缓存,我使用七牛云的对象存储，支持s3接口</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># /etc/gitlab-runner/config.toml缓存部分配置</span>
</span></span><span style="display:flex;"><span>[runners.cache]
</span></span><span style="display:flex;"><span>    Type = <span style="color:#0ff;font-weight:bold">&#34;s3&#34;</span>
</span></span><span style="display:flex;"><span>    Path = <span style="color:#0ff;font-weight:bold">&#34;gitlab-ci-cache&#34;</span>
</span></span><span style="display:flex;"><span>    Shared = <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    MaxUploadedArchiveSize = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    [runners.cache.s3]
</span></span><span style="display:flex;"><span>      ServerAddress = <span style="color:#0ff;font-weight:bold">&#34;s3-cn-east-1.qiniucs.com&#34;</span> <span style="color:#007f7f"># 地址</span>
</span></span><span style="display:flex;"><span>      AccessKey = <span style="color:#0ff;font-weight:bold">&#34;x x x x&#34;</span>
</span></span><span style="display:flex;"><span>      SecretKey = <span style="color:#0ff;font-weight:bold">&#34;xxxxx&#34;</span>
</span></span><span style="display:flex;"><span>      BucketName = <span style="color:#0ff;font-weight:bold">&#34;ljw-devops&#34;</span>
</span></span><span style="display:flex;"><span>      Insecure = <span style="color:#fff;font-weight:bold">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>测试pipeline</li>
</ul>
<p><img loading="lazy" src="/images/gitlab/image-20230127170322537.png" alt="image-20230127170322537"  />
</p>
<p><img loading="lazy" src="/images/gitlab/image-20230127170342079.png" alt="image-20230127170342079"  />
</p>
<p><img loading="lazy" src="/images/gitlab/image-20230127170412259.png" alt="image-20230127170412259"  />
</p>
<h3 id="5jmeter自动化测试集成">5.jmeter自动化测试集成<a hidden class="anchor" aria-hidden="true" href="#5jmeter自动化测试集成">#</a></h3>
<ul>
<li>使用ant+jmeter自动化测试</li>
<li>开启gitlab pages功能收集测试报告进行展示</li>
<li>在项目结束集成后触发这个下游项目进行自动化测试</li>
</ul>
<blockquote>
<p>​	这块不熟，不会写测试文件，后续补充</p>
</blockquote>
<h3 id="6sonarqube代码扫描集成">6.SonarQube代码扫描集成<a hidden class="anchor" aria-hidden="true" href="#6sonarqube代码扫描集成">#</a></h3>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://jary-287.github.io/cloudnative.github.io/tags/cicd/">CICD</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://jary-287.github.io/cloudnative.github.io/posts/think/demo/">
    <span class="title">Next »</span>
    <br>
    <span>这是一个demo文章</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://jary-287.github.io/cloudnative.github.io">Javen&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
